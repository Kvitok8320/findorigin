# Устранение ошибки 403 Yandex Cloud Search API v2

## Проблема
Ошибка 403 "Permission denied" даже при правильно назначенной роли `search-api.webSearch.user`.

## Возможные причины (кроме роли)

### 1. ⚠️ Платежный аккаунт не подключен или не активен (ВЕРОЯТНО ЭТО!)

**Проверка:**
1. Откройте Yandex Cloud Console
2. Перейдите в раздел **"Billing"** (Биллинг) или **"Платежный аккаунт"**
3. Проверьте статус платежного аккаунта:
   - Должен быть **ACTIVE** или **TRIAL_ACTIVE**
   - Если статус другой или аккаунта нет — создайте/активируйте его
4. Убедитесь, что платежный аккаунт привязан к вашему облаку

**Важно:** Даже для бесплатного использования Yandex Cloud Search API требуется активный платежный аккаунт (может быть в статусе TRIAL_ACTIVE для пробного периода).

### 2. Сервис Search API не активирован для каталога

**Проверка:**
1. Откройте Yandex Cloud Console
2. Перейдите в каталог `my-folder` (ID: `b1govdno0cleroqm4huf`)
3. В левом меню найдите раздел **"Сервисы"** или **"Marketplace"**
4. Найдите **"Search API"** или **"Яндекс.Поиск API"**
5. Проверьте, активирован ли сервис для этого каталога
6. Если нет — активируйте его

### 2. Неправильный формат запроса

**Текущий формат в коде:**
- `folderId` передается в body запроса
- Endpoint: `https://searchapi.api.cloud.yandex.net/v2/web/search`

**Возможные варианты:**
- `folderId` должен быть в URL: `?folderId=...`
- Или в заголовке запроса
- Или endpoint неправильный

### 3. Проблема с форматом авторизации

**Проверьте:**
- Используется `Authorization: Api-Key <ключ>` (не `Bearer`)
- Ключ скопирован полностью (без пробелов, переносов строк)
- `YANDEX_AUTH_TYPE=Api-Key` установлен в `.env`

### 4. Права на уровне облака или организации

Ошибка указывает на отсутствие прав на:
- `resource-manager.folder` (каталог) ✅ роль назначена
- `resource-manager.cloud` (облако) ❓ возможно нужна роль
- `organization-manager.organization` (организация) ❓ возможно нужна роль

**Что проверить:**
- Может быть, нужна роль на уровне облака, а не только каталога?
- Или роль должна быть назначена на организацию?

### 5. Проблема с самим API ключом

**Проверьте:**
- Ключ создан для правильного сервисного аккаунта (`findorigin-bot`)
- Ключ не истек (для IAM токенов — 12 часов)
- Ключ скопирован полностью (без обрезки)

## Что сделать

1. **Проверьте активацию сервиса Search API:**
   - В Yandex Cloud Console → каталог → Marketplace
   - Найдите и активируйте Search API, если не активирован

2. **Проверьте документацию API:**
   - Откройте документацию Yandex Cloud Search API v2
   - Сравните формат запроса с тем, что в коде
   - Проверьте, правильный ли endpoint

3. **Попробуйте создать новый API ключ:**
   - Удалите старый ключ
   - Создайте новый для `findorigin-bot`
   - Обновите `YANDEX_API_KEY` в `.env`

4. **Проверьте логи полного запроса:**
   - Запустите `npm run test-yandex-key`
   - Скопируйте полный ответ API (включая все заголовки)
   - Проверьте, есть ли дополнительные подсказки в ответе

