# Проблема: Fetch запрос зависает на Vercel

## Симптомы

Логи показывают:
```
[TELEGRAM] Starting fetch request...
```

Но после этого нет никаких логов - ни успеха, ни ошибки. Запрос просто зависает.

## Возможные причины

### 1. Vercel прерывает выполнение после возврата ответа

**Проблема:** На Vercel serverless функции могут быть прерваны после возврата HTTP ответа, даже если есть незавершенные асинхронные операции.

**Решение:** 
- Добавлена конфигурация `maxDuration = 30` секунд
- Добавлен `setTimeout(0)` для гарантии возврата ответа до начала обработки
- Улучшено логирование для отслеживания выполнения

### 2. Проблемы с сетью на Vercel

**Проблема:** Vercel может иметь ограничения на внешние запросы или проблемы с DNS.

**Решение:**
- Проверьте, что Telegram API доступен: `https://api.telegram.org`
- Попробуйте использовать IP адрес вместо домена (не рекомендуется)
- Проверьте настройки firewall на Vercel

### 3. Таймаут fetch запроса

**Проблема:** Fetch запрос может зависать без таймаута.

**Решение:**
- Уже добавлен `AbortController` с таймаутом 10 секунд
- Улучшено логирование для отслеживания таймаутов

### 4. Проблемы с DNS резолюцией

**Проблема:** Vercel может иметь проблемы с разрешением DNS для `api.telegram.org`.

**Решение:**
- Проверьте логи на наличие DNS ошибок
- Попробуйте использовать другой DNS сервер

## Что было сделано

1. ✅ Добавлено подробное логирование на каждом шаге fetch запроса
2. ✅ Добавлена конфигурация `runtime = 'nodejs'` и `maxDuration = 30`
3. ✅ Добавлен `setTimeout(0)` для гарантии возврата ответа
4. ✅ Улучшена обработка ошибок с детальным логированием

## Следующие шаги

1. **Задеплойте изменения на Vercel**
2. **Отправьте сообщение боту снова**
3. **Проверьте логи** - теперь должно быть больше информации:
   - `[TELEGRAM] Creating fetch request with body: ...`
   - `[TELEGRAM] Fetch promise created, awaiting...`
   - `[TELEGRAM] Fetch promise resolved` (или ошибка)

## Если проблема сохраняется

### Вариант 1: Использовать Vercel Queue

Если fetch запросы не работают, можно использовать Vercel Queue для асинхронной обработки:

```typescript
import { Queue } from '@vercel/queue';

// Вместо прямого вызова processUpdate
await queue.enqueue('process-telegram-update', { update });
```

### Вариант 2: Использовать внешний сервис

Можно использовать внешний сервис (например, Cloudflare Workers) для отправки сообщений в Telegram.

### Вариант 3: Проверить настройки Vercel

1. Зайдите в Settings → Functions
2. Проверьте, нет ли ограничений на внешние запросы
3. Проверьте, не блокируется ли Telegram API

## Диагностика

После деплоя проверьте логи. Должны появиться:
- `[TELEGRAM] Creating fetch request with body: ...`
- `[TELEGRAM] Fetch promise created, awaiting...`

Если этих логов нет - проблема в том, что код не доходит до fetch.
Если эти логи есть, но нет `Fetch promise resolved` - проблема в самом fetch запросе.

