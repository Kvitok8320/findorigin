# Диагностика проблем с ботом

## Проверка 1: Webhook установлен?

```bash
npm run check-webhook
```

Или через браузер:
```
https://api.telegram.org/botВАШ_ТОКЕН/getWebhookInfo
```

**Должно показать:**
- URL webhook (должен быть ваш Vercel URL)
- pending_update_count (должен быть 0 или небольшое число)
- Нет ошибок (last_error_date не должно быть)

## Проверка 2: Переменные окружения на Vercel

1. Зайдите на Vercel → ваш проект
2. Settings → Environment Variables
3. Убедитесь, что есть:
   - `TELEGRAM_BOT_TOKEN` = ваш токен
   - `TELEGRAM_API_URL` = `https://api.telegram.org/bot` (опционально)

**Важно:** После добавления переменных нужно **передеплоить** проект!

## Проверка 3: Endpoint доступен?

Откройте в браузере:
```
https://ВАШ_ПРОЕКТ.vercel.app/api/telegram
```

**Ожидаемый результат:**
- Должна быть ошибка (это нормально, так как это POST endpoint)
- НЕ должно быть 404
- НЕ должно быть 500 с сообщением о токене

## Проверка 4: Логи на Vercel

1. Зайдите на Vercel → ваш проект
2. Deployments → выберите последний деплой
3. Functions → `/api/telegram`
4. Проверьте логи на наличие ошибок

**Что искать:**
- Ошибки "TELEGRAM_BOT_TOKEN is not set"
- Ошибки при отправке сообщений
- Ошибки при обработке update

## Проверка 5: Тест токена

```bash
npm run test-bot
```

Должно показать информацию о боте. Если не работает - проблема с токеном.

## Частые проблемы и решения

### Проблема: Webhook не установлен

**Решение:**
```bash
npm run set-webhook https://ваш-проект.vercel.app
```

### Проблема: Переменные окружения не настроены

**Решение:**
1. Добавьте `TELEGRAM_BOT_TOKEN` в Vercel
2. Передеплойте проект

### Проблема: Бот получает сообщения, но не отвечает

**Возможные причины:**
1. Ошибка в коде обработки сообщений
2. Проблема с отправкой сообщений через Telegram API
3. Таймаут выполнения функции

**Решение:**
- Проверьте логи на Vercel
- Убедитесь, что токен правильный
- Проверьте, что функция не превышает лимит времени выполнения

### Проблема: Бот отвечает несколько раз на одно сообщение

**Причина:** Webhook получает дубликаты обновлений

**Решение:**
- Проверьте `pending_update_count` в getWebhookInfo
- Если есть pending updates, они будут обработаны

### Проблема: Ошибка 500 при обращении к endpoint

**Возможные причины:**
1. Токен не установлен в переменных окружения
2. Ошибка в коде

**Решение:**
- Проверьте логи на Vercel
- Убедитесь, что переменные окружения правильно настроены

## Быстрая диагностика

Выполните все проверки по порядку:

1. ✅ `npm run test-bot` - токен работает?
2. ✅ `npm run check-webhook` - webhook установлен?
3. ✅ Откройте `/api/telegram` в браузере - endpoint доступен?
4. ✅ Проверьте переменные окружения на Vercel
5. ✅ Проверьте логи на Vercel

Если все проверки пройдены, но бот не работает - пришлите логи из Vercel.

