# Настройка Yandex Cloud Search API v2 (поиск по всему интернету)

## Важно понимать:

- **API Яндекс.Поиска для сайта** — только для поиска по конкретному сайту (НЕ подходит)
- **Yandex Cloud Search API v2** — поиск по всему интернету (то, что нам нужно)

## Yandex Cloud Search API v2

Это правильный API для поиска по всему интернету. Работает через:
- **gRPC** (для высокопроизводительных приложений)
- **REST** (проще для интеграции)

## Пошаговая инструкция:

### Шаг 1: Убедитесь, что вы в Yandex Cloud Console

Вы уже там: `console.yandex.cloud/folders/b1govdno0cleroqm4huf/ml/search-api`

### Шаг 2: Откройте документацию

1. На странице Search API нажмите **"Документация"** (синяя ссылка)
2. Изучите документацию по API v2

### Шаг 3: Создайте сервисный аккаунт

1. В левом меню Yandex Cloud найдите **"Сервисные аккаунты"**
2. Нажмите **"Создать сервисный аккаунт"**
3. Заполните:
   - **Имя**: `findorigin-bot`
   - **Описание**: `Сервисный аккаунт для Telegram бота FindOrigin`
4. Нажмите **"Создать"**

### Шаг 4: Получите API ключ (рекомендуется) или IAM токен

**Важно:** Для продакшена нужен только **API ключ**. IAM токен нужен только для тестирования.

1. Откройте созданный сервисный аккаунт
2. Перейдите в **"Ключи"**
3. Нажмите **"Создать новый ключ"**
4. Выберите:
   - **API ключ** (без срока действия) — для продакшена (рекомендуется) ✅
   - **IAM токен** (действует 12 часов) — только для тестирования
5. Скопируйте ключ и сохраните его в безопасном месте
6. **Сохраните ключ в переменную окружения `YANDEX_API_KEY`**

### Шаг 5: Назначьте права доступа (КРИТИЧЕСКИ ВАЖНО!)

**Без правильной роли API не будет работать!**

**Важно:** Роль должна быть назначена НА КАТАЛОГ (folder), а не на сам сервисный аккаунт.

**Способ 1: Через сервисный аккаунт (рекомендуется)**
1. В сервисном аккаунте перейдите в **"Права доступа"**
2. Нажмите **"Назначить роли"** (синяя кнопка справа вверху)
3. В открывшемся окне:
   - Выберите ресурс: **"Каталог"** → выберите `default` (b1govdno0cleroqm4huf)
   - Добавьте роль: **"search-api.webSearch.user"**
4. Нажмите **"Сохранить"**

**Способ 2: Через каталог (РЕКОМЕНДУЕТСЯ, если способ 1 не работает)**

1. В левом меню Yandex Cloud найдите **"Каталоги"** (или "Folders")
2. Нажмите на ваш каталог `my-folder` или `default` (ID: `b1govdno0cleroqm4huf`)
3. В открывшемся каталоге найдите раздел **"Права доступа"** (Access rights) в левом меню или вверху страницы
4. Нажмите кнопку **"Назначить роли"** (Assign roles) — обычно справа вверху
5. В открывшемся окне:
   - В поле поиска введите `findorigin-bot` или найдите сервисный аккаунт в списке
   - Выберите сервисный аккаунт `findorigin-bot` (с иконкой робота)
6. Нажмите **"+ Добавить роль"** (Add role)
7. В списке ролей найдите и выберите: **"search-api.webSearch.user"**
   - Если не видите, попробуйте поискать по "search" или "webSearch"
8. Нажмите **"Сохранить"** (Save)

**Проверка роли (обязательно!):**
1. Откройте каталог `my-folder` или `default` (ID: `b1govdno0cleroqm4huf`)
2. Перейдите в **"Права доступа"** (Access rights)
3. В таблице найдите строку с сервисным аккаунтом `findorigin-bot`
4. В колонке **"Роли"** (Roles) должна быть указана роль `search-api.webSearch.user`
5. Если роли нет или указана другая роль — удалите неправильную и назначьте правильную

**Важно:**
- Роль должна быть назначена **НА КАТАЛОГ** для сервисного аккаунта
- **НЕ путайте** с разделом "Права доступа к сервисному аккаунту" — это показывает, кто имеет доступ К аккаунту, а не к чему имеет доступ сам аккаунт
- Если вы назначили роль "всем в каталоге" — это неправильно, нужно назначить конкретно сервисному аккаунту

### Шаг 6: Получите Folder ID

Ваш Folder ID уже известен: `b1govdno0cleroqm4huf` (из URL)

### Шаг 7: Настройка в Vercel

1. Зайдите на https://vercel.com
2. Откройте проект
3. Перейдите в **Settings** → **Environment Variables**
4. Добавьте:
   - **Key**: `YANDEX_API_KEY`
   - **Value**: ваш IAM токен или API ключ
   - **Key**: `YANDEX_FOLDER_ID`
   - **Value**: `b1govdno0cleroqm4huf`
5. Сохраните
6. **Передеплойте проект**

## Endpoint для API v2

Согласно документации, API v2 использует:
- **REST**: `POST https://searchapi.api.cloud.yandex.net/v2/web/search`
- **Авторизация**: 
  - `Authorization: Bearer <IAM-токен>` (для IAM токенов)
  - `Authorization: Api-Key <API-ключ>` (для API ключей, рекомендуется)
- **Роль**: `search-api.webSearch.user` (обязательно! Назначается на каталог)
- **folderId**: Должен быть в теле запроса (обязательно!)

## Документация

- Yandex Cloud Search API: https://yandex.cloud/en/services/search-api
- Документация API v2: доступна в консоли Yandex Cloud

## Важно

- API v2 работает по **всему интернету**, а не по конкретному сайту
- Требует настройки в Yandex Cloud (не просто ключ из Кабинета разработчика)
- IAM токены нужно обновлять каждые 12 часов (или использовать API ключи)
- **Для продакшена используйте только API ключ** — IAM токен не нужен
- **Роль `search-api.webSearch.user` обязательна** — без неё API не будет работать

## Устранение неполадок

### Запрос зависает или возвращает 401/403

1. **Проверьте роль:**
   - Откройте сервисный аккаунт → "Права доступа"
   - Убедитесь, что на каталоге назначена роль `search-api.webSearch.user`
   - Если видите другую роль (например, `viewer`) — удалите её и назначьте правильную

2. **Проверьте формат авторизации:**
   - API ключ должен использовать формат: `Authorization: Api-Key <ключ>`
   - IAM токен должен использовать формат: `Authorization: Bearer <токен>`
   - Код автоматически пробует оба формата при ошибке 401/403

3. **Проверьте переменные окружения:**
   - `YANDEX_API_KEY` — должен содержать API ключ или IAM токен
   - `YANDEX_FOLDER_ID` — должен содержать ID каталога (например, `b1govdno0cleroqm4huf`)
   - Обе переменные должны быть добавлены в Vercel и проект должен быть передеплоен

